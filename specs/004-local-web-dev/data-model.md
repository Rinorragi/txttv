# Data Model: Local Web Development Workflow

**Feature**: [spec.md](spec.md) | **Date**: February 7, 2026  
**Phase**: Phase 1 - Design

## Entity Definitions

### 1. Web Interface Source

**Description**: HTML, CSS, and JavaScript files that define the text TV user interface for local development.

**Location**: `src/web/`

**Attributes**:
- **Path**: Absolute or repository-relative path to source files
- **Type**: File extension (`.html`, `.css`, `.js`)
- **Purpose**: Component type (template, stylesheet, script, asset)
- **Encoding**: UTF-8 (required for proper character handling)
- **Size**: File size in bytes (soft limit ~50 KB for templates)

**Components**:
```
src/web/
â”œâ”€â”€ index.html              # Entry point (landing page, page selector)
â”œâ”€â”€ styles/
â”‚   â””â”€â”€ txttv.css          # Shared CSS (~2-3 KB, inline in fragments)
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ navigation.js      # Page navigation logic
â”‚   â””â”€â”€ content-loader.js  # Dynamic content loading from content/pages/
â””â”€â”€ templates/
    â””â”€â”€ page-template.html # Template for individual TXT TV pages
```

**Relationships**:
- **Templates** â†’ **Policy Fragments** (one-to-many: template generates multiple fragments)
- **Stylesheets** â†’ **Policy Fragments** (embedded in each fragment)
- **Scripts** â†’ **Policy Fragments** (embedded or CDN-referenced)

**Lifecycle**:
1. Created/edited by developer in `src/web/`
2. Opened directly in browser for local testing (no server required)
3. Read by conversion script
4. Transformed into Policy Fragments

---

### 2. Policy Fragment

**Description**: An APIM policy XML file containing embedded web content (HTML/CSS/JS) that renders part of the text TV interface when deployed.

**Location**: `infrastructure/modules/apim/fragments/`

**Attributes**:
- **Fragment ID**: Unique identifier (e.g., `page-100`, `page-101`)
- **File Name**: XML file name (e.g., `page-100.xml`)
- **Size**: File size in bytes (hard limit: 256 KB per APIM)
- **Content**: CDATA section with embedded HTML
- **Encoding**: UTF-8 with BOM
- **Status**: Draft, Validated, Deployed

**Structure**:
```xml
<fragment>
  <set-body>
    <![CDATA[
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <title>TXT TV - Page {PAGE_NUMBER}</title>
        <style>/* Inline CSS */</style>
      </head>
      <body>
        <div class="txttv-page">{CONTENT}</div>
        <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"></script>
        <script>/* Inline JS */</script>
      </body>
      </html>
    ]]>
  </set-body>
</fragment>
```

**Validation Rules**:
- Root element MUST be `<fragment>`
- Child elements MUST be valid APIM policy elements (`set-body`, `set-header`, etc.)
- HTML content MUST be wrapped in CDATA section
- CDATA terminators (`]]>`) MUST be escaped if present in content
- File size MUST NOT exceed 256 KB
- XML MUST be well-formed

**Relationships**:
- **Generated From** â†’ **Web Interface Source** (via Conversion Script)
- **Referenced By** â†’ **Routing Policy** (include-fragment directive)
- **Contains** â†’ **Text TV Page Content** (embedded in HTML)

**Lifecycle**:
1. Generated by `convert-web-to-apim.ps1` from Web Interface Source
2. Validated by `Validate-ApimPolicies.ps1` (4 layers)
3. Committed to Git
4. Deployed via Bicep to APIM
5. Executed by APIM policy engine on request

---

### 3. Text TV Page Content

**Description**: Plain text content files containing the actual text displayed on each TXT TV page.

**Location**: `content/pages/`

**Attributes**:
- **Page Number**: Integer (100-110, extensible to more pages)
- **File Name**: Pattern `page-{NUMBER}.txt`
- **Content**: Plain text (max 2000 characters)
- **Encoding**: UTF-8
- **Format**: Monospaced-optimized (for retro terminal aesthetic)

**Example Content**:
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TXT TV - PAGE 100
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Weather Forecast:
  Helsinki: â˜ï¸  12Â°C
  Turku:    ğŸŒ§  10Â°C
  Oulu:     â„ï¸   5Â°C

Sports Results:
  Football: Team A 2-1 Team B
  Hockey:   Team C 3-2 Team D

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Next: 101 | Previous: 110 | Index: 100
```

**Relationships**:
- **Embedded In** â†’ **Policy Fragment** (content injected during conversion)
- **Loaded By** â†’ **Web Interface Source** (during local development)

**Lifecycle**:
1. Created/edited by content authors
2. Read by local dev server (for preview)
3. Read by conversion script (for fragment generation)
4. Embedded in Policy Fragment HTML

---

### 4. Local Development Server

**Description**: A web server process running on the developer's machine that serves the interface at localhost.

**Technology**: Node.js `live-server`

**Attributes**:
- **Port**: TCP port number (default: 8080, configurable to 3000)
- **Root Directory**: `src/web/`
- **URL**: `http://localhost:{PORT}/`
- **Live Reload**: Enabled (WebSocket-based)
- **Process ID**: OS process identifier
- **Status**: Running, Stopped, Error

**Configuration**:
```powershell
# Command
live-server src/web --port=3000 --open=/index.html --no-browser

# Behavior
# - Watches src/web/ for changes
# - Auto-reloads browser on file save
# - Serves static files
# - CORS enabled
```

**Relationships**:
- **Serves** â†’ **Web Interface Source** (HTTP responses)
- **Monitors** â†’ **Web Interface Source** (file system changes)

**Lifecycle**:
1. Started by developer (`live-server` command or helper script)
2. Serves files from `src/web/`
3. Watches for file changes
4. Triggers browser reload on change
5. Stopped by developer (Ctrl+C)

---

### 5. Conversion Script

**Description**: A PowerShell command-line tool that transforms web interface source files into APIM policy fragments.

**Location**: `infrastructure/scripts/convert-web-to-apim.ps1`

**Attributes**:
- **Input Path**: `src/web/templates/page-template.html`
- **Output Path**: `infrastructure/modules/apim/fragments/`
- **Content Source**: `content/pages/`
- **Mode**: Full conversion or incremental (future)
- **Validation**: Enabled/Disabled (default: enabled)
- **Exit Code**: 0 (success), 1 (failure)

**Process Flow**:
```
1. Read template from src/web/templates/page-template.html
2. Read CSS from src/web/styles/txttv.css
3. Read JS from src/web/scripts/*.js
4. For each page in content/pages/
   a. Read page content
   b. Inject content into template (replace {CONTENT})
   c. Inject page number (replace {PAGE_NUMBER})
   d. Inline CSS and JS
   e. Escape CDATA terminators
   f. Wrap in <fragment><set-body><![CDATA[...]]></set-body></fragment>
   g. Save to fragments/page-{NUMBER}.xml
   h. Validate generated XML (4 layers)
5. Report conversion results (success/failure counts)
```

**Validation Steps**:
- Layer 1: XML well-formedness
- Layer 2: APIM schema compliance
- Layer 3: Security scanning (XSS, injection)
- Layer 4: Integration tests (optional, via Pester)

**Relationships**:
- **Reads** â†’ **Web Interface Source**
- **Reads** â†’ **Text TV Page Content**
- **Generates** â†’ **Policy Fragments**
- **Invokes** â†’ **Validation Functions**

**Lifecycle**:
1. Invoked by developer after UI changes
2. Processes all pages or specific page
3. Generates/updates policy fragments
4. Validates output
5. Exits with status code

---

### 6. Routing Policy

**Description**: APIM policy XML that routes requests to appropriate policy fragments based on page number parameter.

**Location**: `infrastructure/modules/apim/policies/page-routing-policy.xml`

**Attributes**:
- **Policy Type**: Inbound processing
- **Routing Logic**: Query parameter-based (`?page=100`)
- **Default Page**: 100 (if no page parameter)
- **Cache Strategy**: Response caching (optional)
- **Fragment References**: List of fragment IDs to include

**Structure**:
```xml
<policies>
  <inbound>
    <!-- Extract page number from query parameter -->
    <set-variable name="pageNumber" 
                  value="@(context.Request.Url.Query.GetValueOrDefault("page", "100"))" />
    
    <!-- Route to appropriate fragment -->
    <choose>
      <when condition="@(context.Variables["pageNumber"] == "100")">
        <include-fragment fragment-id="page-100" />
      </when>
      <when condition="@(context.Variables["pageNumber"] == "101")">
        <include-fragment fragment-id="page-101" />
      </when>
      <!-- ... more pages ... -->
      <otherwise>
        <return-response>
          <set-status code="404" reason="Page Not Found" />
          <set-body>Page not found</set-body>
        </return-response>
      </otherwise>
    </choose>
    
    <!-- Set response headers -->
    <set-header name="Content-Type" exists-action="override">
      <value>text/html; charset=utf-8</value>
    </set-header>
    
    <!-- Optional: Response caching -->
    <cache-lookup vary-by-developer="false">
      <vary-by-query-parameter>page</vary-by-query-parameter>
    </cache-lookup>
  </inbound>
  
  <outbound>
    <cache-store duration="3600" />
  </outbound>
</policies>
```

**Relationships**:
- **Includes** â†’ **Policy Fragments** (via fragment ID references)
- **Deployed By** â†’ **Bicep Module** (`infrastructure/modules/apim/main.bicep`)

---

## Entity Relationships Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Developer               â”‚
â”‚ - Edits Web Source      â”‚
â”‚ - Runs Local Server     â”‚
â”‚ - Runs Conversion       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚ Web Interface Source â”‚
     â”‚           â”‚ (src/web/)           â”‚
     â”‚           â”‚ - HTML templates     â”‚
     â”‚           â”‚ - CSS stylesheets    â”‚
     â”‚           â”‚ - JS scripts         â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚
     â”‚                  â”‚ Served by
     â”‚                  â–¼
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚ Local Dev Server     â”‚
     â”‚           â”‚ (live-server)        â”‚
     â”‚           â”‚ - Port 3000          â”‚
     â”‚           â”‚ - Live reload        â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Conversion Script    â”‚
                 â”‚ (PowerShell)         â”‚
                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
         Reads          â”‚          Reads
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  â”‚                  â”‚
    â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Templates â”‚   â”‚ Stylesheets â”‚   â”‚ Content  â”‚
â”‚ (.html)   â”‚   â”‚ (.css)      â”‚   â”‚ (.txt)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Generates
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Policy Fragment â”‚
              â”‚ (.xml)          â”‚
              â”‚ - CDATA HTML    â”‚
              â”‚ - Inline CSS/JS â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Referenced by
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Routing Policy  â”‚
              â”‚ (APIM)          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Deployed via
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Bicep Module    â”‚
              â”‚ (IaC)           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Scenarios

### Scenario 1: Local Development

```
1. Developer edits src/web/templates/page-template.html
2. Live-server detects file change
3. Live-server triggers browser reload
4. Browser fetches updated index.html from live-server
5. Browser renders updated interface at localhost:3000
```

### Scenario 2: Policy Fragment Generation

```
1. Developer runs infrastructure/scripts/convert-web-to-apim.ps1
2. Script reads page-template.html from src/web/templates/
3. Script reads txttv.css from src/web/styles/
4. Script reads navigation.js from src/web/scripts/
5. For page 100:
   a. Script reads content/pages/page-100.txt
   b. Script injects content into template
   c. Script inlines CSS and JS
   d. Script wraps in <fragment><set-body><![CDATA[...]]></set-body></fragment>
   e. Script saves to infrastructure/modules/apim/fragments/page-100.xml
   f. Script validates XML (4 layers)
6. Script repeats for pages 101-110
7. Script reports: "10 fragments generated, 10 validated, 0 errors"
```

### Scenario 3: APIM Request Processing

```
1. HTTP GET https://txttv.example.com/pages?page=100
2. Application Gateway forwards to APIM
3. WAF validates request (no attacks detected)
4. APIM executes page-routing-policy.xml
5. Policy extracts page=100 from query parameter
6. Policy includes fragment "page-100"
7. APIM loads infrastructure/modules/apim/fragments/page-100.xml
8. APIM executes <set-body> with CDATA HTML
9. APIM sets Content-Type: text/html
10. APIM returns HTTP 200 with rendered HTML
11. Browser displays TXT TV page 100
```

---

## Size and Scale Constraints

| Entity | Constraint | Current | Limit |
|--------|-----------|---------|-------|
| **Policy Fragment** | Max size | 5-8 KB | 256 KB |
| **Text TV Page Content** | Max characters | ~500-800 | 2000 |
| **Total Fragments** | Count | 10 (pages 100-110) | 100 (APIM Standard) |
| **Local Dev Server** | Port | 3000 | 1-65535 |
| **Conversion Time** | Target | <30s | <30s (SC-003) |
| **Policy Execution** | Response time | <200ms | <200ms |

---

## Validation Rules Summary

### Web Interface Source
- âœ… Must be valid HTML5
- âœ… Must use UTF-8 encoding
- âœ… CSS should be <5 KB for inline inclusion
- âœ… JS can use ES6+ features (modern browsers)

### Policy Fragment
- âœ… Must be well-formed XML
- âœ… Root element must be `<fragment>`
- âœ… HTML must be wrapped in CDATA
- âœ… Must escape `]]>` sequences
- âœ… Must not exceed 256 KB
- âœ… Must pass security scan (no XSS)

### Text TV Page Content
- âœ… Must be UTF-8 plain text
- âœ… Should be <2000 characters
- âœ… Should use monospaced-friendly characters
- âš ï¸ May contain Unicode (emojis supported)

---

## Future Extensibility

### Planned Enhancements
- **Incremental Conversion**: Convert only changed pages
- **Template Variants**: Multiple templates for different page types
- **Asset Pipeline**: Minification and optimization
- **Preview Mode**: Local server mimics APIM behavior
- **Shared CSS Fragment**: Extract common CSS to reduce duplication

### Schema Evolution
- **Versioning**: Add version attribute to fragments
- **Metadata**: Add creation timestamp, generator version
- **Dependencies**: Track template â†’ fragment lineage

---

**Next Steps**: See [contracts/](contracts/) for detailed interface specifications and [quickstart.md](quickstart.md) for developer workflow.
